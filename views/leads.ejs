<%- include('partials/_head') %>
<link rel="stylesheet" href="/vendor/select2/dist/css/select2.min.css" />
<link rel="stylesheet" href="/stylesheets/leads.css" />

<body class="hold-transition sidebar-mini">
<div class="wrapper">
  <%- include('partials/_navbar') %>
  <%- include('partials/_sidebar', { active: 'leads' }) %>

  <div class="content-wrapper">
    <section class="content pt-3">
      <div class="container-fluid">

        <!-- Header -->
        <div class="row mb-2">
          <div class="col-sm-6"><h1 class="m-0 text-dark">Prospect</h1></div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
              <li class="breadcrumb-item active">Leads</li>
            </ol>
          </div>
        </div>

        <!-- Toolbar -->
        <div class="card mb-3">
          <div class="card-body top-toolbar">
            <div class="btn-group">
              <button id="btnAddNew" type="button" class="btn btn-success" data-toggle="modal" data-target="#leadModal">
                <i class="fas fa-plus"></i> Add New
              </button>
              <button id="btnRefresh" class="btn btn-primary">
                <i class="fas fa-sync-alt mr-1"></i> Refresh
              </button>
            </div>

            <div class="search-wrap">
              <div class="input-group">
                <input id="q" class="form-control" placeholder="Search all prospects" autocomplete="off">
                <div class="input-group-append">
                  <button id="btnSearch" class="btn btn-outline-secondary">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="text-right">
              <button class="btn btn-outline-primary btn-adv-search" type="button">
                <i class="fas fa-sliders-h mr-1"></i> Advance Search
              </button>
            </div>
          </div>
        </div>

        <!-- Funnel / status bar -->
        <div class="card mb-3 funnel-card">
          <div class="pipeline">
            <div class="pipeline-inner">
              <div class="pipeline-line"></div>
              <div id="statusPipeline" class="funnel-bar">
                <!-- JS দিয়ে স্টেজগুলো ভরবে -->
                <div class="text-muted">Loading status summary...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center mb-3">
              <span class="mr-2 text-muted small">Show</span>
            
              <div class="page-size-wrapper">
                <select id="pageSize" class="form-control form-control-sm page-size-select">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
                <span class="page-size-chevron">
                  <i class="fas fa-chevron-down"></i>
                </span>
              </div>
            
              <span class="ml-2 text-muted small">entries</span>
            </div>
            
            <div>
              <button id="btnTemplate" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-cloud-download-alt mr-1"></i> Template
              </button>
              <button class="btn btn-outline-primary btn-sm" data-toggle="modal" data-target="#bulkModal">
                <i class="fas fa-file-upload mr-1"></i> Bulk Upload
              </button>
            </div>
          </div>

          <div class="card-body table-responsive p-0">
            <table class="table table-hover text-nowrap table-prospect" id="tbl">
              <thead>
                <tr>
                  <th>Prospect ID</th>
                  <th>Prospect Details</th>
                  <th>Primary Contact</th>
                  <th>Followup Activity</th>
                  <th>Stage</th>
                  <th>Assigns &amp; Creator</th>
                  <th>Last &amp; Next Activity</th>
                  <th class="text-right">Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="card-footer d-flex justify-content-between align-items-center">
            <small id="pageInfo"></small>
            <div>
              <button id="prev" class="btn btn-default btn-sm">Prev</button>
              <button id="next" class="btn btn-default btn-sm">Next</button>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <%- include('partials/_footer') %>
</div>

<!-- Add Prospect Modal -->
<div class="modal fade" id="leadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content modal-prospect">

      <div class="modal-header">
        <div>
          <h5 class="modal-title mb-1" id="leadModalTitle">Add New Prospect</h5>
          <p class="modal-subtitle mb-0">
            Fields with <span class="text-danger">*</span> are required.
          </p>
        </div>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <ul class="nav nav-pills" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" data-toggle="pill" href="#t-initial" role="tab">
              Initial Info
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle="pill" href="#t-basic" role="tab">
              Basic Info
            </a>
          </li>
        </ul>

        <form id="fLead" autocomplete="off">
          <div class="tab-content">

            <!-- Initial Info -->
            <div class="tab-pane fade show active" id="t-initial" role="tabpanel">
              <div class="form-section-title">Prospect Type</div>
              <div class="form-section-subtitle">
                Choose whether this is an individual or an organization.
              </div>

              <div class="form-row mb-3">
                <div class="col-md-6">
                  <div class="btn-group btn-group-toggle" data-toggle="buttons">
                    <label class="btn btn-outline-primary btn-sm active">
                      <input type="radio" name="prospect_type" value="Individual" checked> Individual
                    </label>
                    <label class="btn btn-outline-primary btn-sm">
                      <input type="radio" name="prospect_type" value="Organization"> Organization
                    </label>
                  </div>
                </div>
              </div>

              <div class="form-section-title">Contact Details</div>
              <div class="form-section-subtitle">
                Basic information about the prospect and main contact.
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label>Prospect Name <span class="text-danger">*</span></label>
                  <input class="form-control" id="prospect_name" required>
                </div>
                <div class="form-group col-md-6">
                  <label>Primary Contact (Mobile) <span class="text-danger">*</span></label>
                  <input class="form-control" id="primary_mobile" required>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label>Alternative Contact</label>
                  <input class="form-control" id="alternative_mobile">
                </div>
                <div class="form-group col-md-6">
                  <label>Primary Email</label>
                  <input type="email" class="form-control" id="primary_email">
                </div>
              </div>

              <div class="form-section-title">Project Details</div>
              <div class="form-section-subtitle">
                What kind of project or service is the prospect interested in?
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label>Project Type</label>
                  <input class="form-control" id="project_type">
                </div>
                <div class="form-group col-md-6">
                  <label>Project Size</label>
                  <input class="form-control" id="project_size">
                </div>
              </div>

              <div class="form-group">
                <label>Project Details</label>
                <textarea class="form-control" id="project_details" rows="2"></textarea>
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label>Prospect Stage</label>
                  <select id="prospect_stage_id" class="form-control w-100"></select>
                </div>
                <div class="form-group col-md-6">
                  <label>Prospect Priority</label>
                  <select id="priority" class="form-control">
                    <option value="Normal">Normal</option>
                    <option value="High">High</option>
                    <option value="Low">Low</option>
                  </select>
                </div>
              </div>
              <div class="form-section-title mt-3">Assignments</div>
                <div class="form-section-subtitle">
                  Choose who will own this prospect and any additional assignees.
                </div>

                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label>Primary Assignee</label>
                    <select id="assign_user_id" class="form-control">
                      <option value="">Me (default)</option>
                      <!-- JS দিয়ে ইউজার লিস্ট আসবে -->
                    </select>
                  </div>
                  <div class="form-group col-md-6">
                    <label>Additional Assignees</label>
                    <select id="additional_assign_user_ids" class="form-control" multiple>
                      <!-- JS দিয়ে ইউজার লিস্ট আসবে -->
                    </select>
                    <small class="form-text text-muted">
                      Hold Ctrl/⌘ to select multiple users.
                    </small>
                  </div>
                </div>

            </div>

            <!-- Basic Info -->
            <div class="tab-pane fade" id="t-basic" role="tabpanel">
              <div class="form-section-title">Location</div>
              <div class="form-section-subtitle">
                Where is the prospect located?
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label>District</label>
                  <input class="form-control" id="district">
                </div>
                <div class="form-group col-md-6">
                  <label>Thana</label>
                  <input class="form-control" id="thana">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label>Area</label>
                  <input class="form-control" id="area">
                </div>
                <div class="form-group col-md-6">
                  <label>Street Details</label>
                  <input class="form-control" id="street_details">
                </div>
              </div>

              <div class="form-section-title">Campaign &amp; Source</div>
              <div class="form-section-subtitle">
                Track how this prospect came into your funnel.
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label>Campaign Name</label>
                  <input class="form-control" id="campaign">
                </div>
                <div class="form-group col-md-6">
                  <label>Information Source</label>
                  <input class="form-control" id="info_source">
                </div>
              </div>
            </div>

          </div>

          <div class="mt-3 d-flex justify-content-end">
            <button type="button" class="btn btn-outline-secondary mr-2" data-dismiss="modal">
              Cancel
            </button>
            <button class="btn btn-primary" type="submit">
              Save
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- Follow up -->
<div class="modal fade" id="followupModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <form id="fFollowup">
        <div class="modal-header">
          <h5 class="modal-title">Add Follow-up</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">

          <input type="hidden" id="fu_lead_id">

          <div class="form-group">
            <label>Activity Type</label>
            <select id="fu_type" class="form-control">
              <option value="call">Call</option>
              <option value="sms">SMS</option>
              <option value="email">Email</option>
              <option value="visit">Visit</option>
              <option value="meeting">Meeting</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label>Note</label>
            <textarea id="fu_note" class="form-control" rows="2"></textarea>
          </div>

          <div class="form-group">
            <label>Next Follow-up (optional)</label>
            <input type="datetime-local" id="fu_next_at" class="form-control">
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk upload modal -->
<div class="modal fade" id="bulkModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Bulk Upload Leads (CSV)</h5>
        <button type="button" class="close" data-dismiss="modal"><span>×</span></button>
      </div>
      <div class="modal-body">
        <form id="fBulk">
          <div class="form-group">
            <label>Select CSV file</label>
            <input type="file" class="form-control-file" id="bulkFile" accept=".csv" required>
          </div>
          <button class="btn btn-primary" type="submit">Upload</button>
        </form>
        <div id="bulkResult" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- Follow-up Timeline Modal -->
<div class="modal fade" id="activityTimelineModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="activityTimelineTitle">Follow-up history</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="activityTimelineBody" class="timeline-list">
          <!-- JS দিয়ে টাইমলাইন এখানে আসবে -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<%- include('partials/_scripts') %>
<script src="/vendor/select2/dist/js/select2.full.min.js"></script>
<script src="/javascripts/leads.js" defer></script>
</body>
